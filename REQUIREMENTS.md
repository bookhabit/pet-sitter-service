# 펫시터 애플리케이션 요구사항 정의서

## 1. 프로젝트 개요

### 1.1 애플리케이션 소개
- **펫시터**: 반려동물을 돌볼 시간이 없는 반려동물 주인과 반려동물을 돌보려고 하는 돌봄 도우미를 연결해주는 애플리케이션

### 1.2 개발 Flow
1. 요구사항 및 도메인 모델 정의
2. OpenAPI로 명세서 작성
3. 프론트엔드와 백엔드 각각 명세서를 참고하여 작업
4. 애플리케이션 통합 및 연동

---

## 2. 초기 요구사항

### 2.1 핵심 기능 (v1)
- **회원가입**: 반려동물 주인과 반려동물을 돌볼 돌봄 도우미
- **구인 공고 등록**: 반려동물 주인이 여러 반려동물 정보를 포함한 구인 공고를 올림
- **지원 기능**: 돌봄 도우미가 공고를 보고 지원
- **구인공고 조회**: 필터링, 페이징, 검색 기능을 통해 구인공고를 효율적으로 조회

### 2.2 신규 기능 (v2)
- **사진 업로드**: 프로필/공고/반려동물 사진 업로드
- **리뷰 및 평점**: 펫시터에 대한 별점(1~5) + 리뷰 텍스트
- **공고 필드 확장**: 위치정보(주소, 위도, 경도) + 가격(시간당/일당)
- **채팅 기능**: 공고 등록자와 지원자 간 1:1 채팅
- **즐겨찾기**: 펫시터가 관심 공고를 저장하고 확인

---

## 3. 도메인 모델링

### 3.1 모델 정의

#### 3.1.1 모델 식별 (v1)
- **User (사용자)**: 반려동물 주인과 돌봄 도우미가 애플리케이션을 사용하므로 필요
- **Job (구인공고)**: 반려동물 주인이 구인공고를 등록하고, 돌봄 도우미가 구인 공고를 보고 지원하므로 필요
- **Pet (반려동물)**: 구인공고는 여러 유형의 반려동물을 다루는 내용이므로 필요 (강아지, 고양이, 새 등)
- **JobApplication (구인공고 지원)**: 구인 공고 지원 모델 필요

#### 3.1.2 신규 모델 식별 (v2)
- **Photo (사진)**: 사용자/공고/반려동물에 연결되는 사진 파일 메타데이터
- **Review (리뷰)**: 펫오너가 공고 완료 후 펫시터에게 남기는 평가
- **ChatRoom (채팅방)**: 첫 메시지 전송 시 생성되는 1:1 채팅 공간
- **Message (메시지)**: 채팅방 내 개별 메시지
- **Favorite (즐겨찾기)**: 펫시터가 저장한 관심 공고

---

### 3.2 모델 속성 정의

#### 3.2.1 User (사용자)
- `id`: 사용자 고유 식별자
- `emailAddress`: 이메일 주소
- `password`: 비밀번호
- `fullName`: 전체 이름
- `roles`: 역할 (반려동물 주인, 돌봄 도우미, 관리자)
- `photos`: 프로필 사진 목록 (Photo 모델 참조, 1:N 관계) *(신규 v2)*

#### 3.2.2 Job (구인공고)
- `id`: 구인공고 고유 식별자
- `startTime`: 시작 시간
- `endTime`: 종료 시간
- `activity`: 활동 내용
- `pets`: 반려동물 정보 목록 (Pet 모델 참조, 1:N 관계)
- `address`: 주소 텍스트 *(신규 v2)*
- `latitude`: 위도 *(신규 v2)*
- `longitude`: 경도 *(신규 v2)*
- `price`: 가격 (원 단위) *(신규 v2)*
- `price_type`: 가격 유형 (hourly/daily) *(신규 v2)*
- `photos`: 공고 사진 목록 (Photo 모델 참조, 1:N 관계) *(신규 v2)*

#### 3.2.3 Pet (반려동물)
- `id`: 반려동물 고유 식별자
- `name`: 이름
- `age`: 나이
- `animalType`: 동물 유형 (DOG, CAT, BIRD, RABBIT, HAMSTER, ETC)
- `breed`: 품종/종류
- `size`: 크기 (SMALL, MEDIUM, LARGE)
- `jobId`: 소속 구인공고 ID
- `photos`: 반려동물 사진 목록 (Photo 모델 참조, 1:N 관계) *(신규 v2)*

#### 3.2.4 JobApplication (구인공고 지원)
- `id`: 지원 고유 식별자
- `status`: 지원 상태 (applying, approved, rejected)
- `user_id`: 지원자 ID
- `job_id`: 구인공고 ID

#### 3.2.5 Photo (사진) *(신규 v2)*
- `id`: 사진 고유 식별자
- `url`: 접근 가능한 HTTP URL
- `file_name`: 서버에 저장된 파일명 (UUID 기반)
- `original_name`: 원본 파일명
- `mime_type`: 파일 형식 (image/jpeg, image/png, image/webp)
- `size`: 파일 크기 (bytes)
- `uploader_id`: 업로드한 사용자 ID
- `user_id`: 프로필 사진 소유자 ID (nullable)
- `job_id`: 연결된 공고 ID (nullable)
- `pet_id`: 연결된 반려동물 ID (nullable)
- 제약: user_id / job_id / pet_id 중 하나만 설정

#### 3.2.6 Review (리뷰) *(신규 v2)*
- `id`: 리뷰 고유 식별자
- `rating`: 별점 (1~5 정수)
- `comment`: 리뷰 텍스트 (선택)
- `reviewer_id`: 작성자 ID (PetOwner)
- `reviewee_id`: 대상자 ID (PetSitter)
- `job_id`: 해당 공고 ID (공고당 리뷰 1개 제약)

#### 3.2.7 ChatRoom (채팅방) *(신규 v2)*
- `id`: 채팅방 고유 식별자
- `job_application_id`: 연결된 지원 ID (1:1 관계)

#### 3.2.8 Message (메시지) *(신규 v2)*
- `id`: 메시지 고유 식별자
- `content`: 메시지 내용
- `sender_id`: 발신자 ID
- `chat_room_id`: 채팅방 ID

#### 3.2.9 Favorite (즐겨찾기) *(신규 v2)*
- `id`: 즐겨찾기 고유 식별자
- `user_id`: 펫시터 ID
- `job_id`: 공고 ID
- 제약: (user_id, job_id) 조합 유일 (중복 즐겨찾기 방지)

---

## 4. 사용자 시나리오

### 4.1 시나리오 형식
**'나는 <역할>로서 <기능>을 할 수 있고, 그 결과 <보상>을 받는다'**

### 4.2 공통 사용자 시나리오

#### 4.2.1 회원가입 및 로그인
- 나는 역할을 선택해서 새 사용자를 등록할 수 있고, 그 결과 로그인할 수 있다
- 나는 로그인할 수 있고, 그 결과 마켓플레이스를 이용할 수 있다

#### 4.2.2 계정 관리
- 나는 내 계정 상세 정보를 수정할 수 있다
- 나는 내 계정을 삭제할 수 있다
- 나는 프로필 사진을 업로드할 수 있다 *(신규 v2)*

### 4.3 반려동물 주인 사용자 시나리오

#### 4.3.1 구인공고 관리
- 나는 펫시터에 한 마리 이상의 여러 유형의 반려동물 정보를 포함하는 구인공고를 올릴 수 있고, 그 결과 반려동물 돌봄 도우미가 구인공고를 보고 지원할 수 있다
- 나는 공고에 위치 정보와 가격 정보를 포함할 수 있다 *(신규 v2)*
- 나는 공고에 사진을 업로드할 수 있다 *(신규 v2)*
- 나는 내가 등록한 구인공고 목록을 확인할 수 있다
- 구인공고를 등록하면 상세 내용을 조회하고 수정할 수 있다
- 구인공고를 등록하면 등록한 구인공고를 삭제할 수 있다

#### 4.3.2 지원자 관리
- 구인공고를 등록하면 구인공고에 지원한 돌봄 도우미를 확인할 수 있다
- 적절한 지원자가 있다면 승인할 수 있다
- 공고가 완료되면 펫시터에게 리뷰와 별점을 남길 수 있다 *(신규 v2)*
- 지원자와 채팅으로 소통할 수 있다 *(신규 v2)*

### 4.4 돌봄 도우미 사용자 시나리오

#### 4.4.1 구인공고 조회 및 지원
- 나는 돌봄이 필요한 반려동물 목록을 조회할 수 있다
- 나는 구인공고를 기준에 따라 필터링해서 페이지 단위로 조회할 수 있다 (동물 유형, 크기, 활동 유형, 가격 범위 등)
- 나는 구인공고를 검색어로 검색할 수 있다
- 마음에 드는 구인 공고가 있으면 지원할 수 있다
- 마음에 드는 공고를 즐겨찾기로 저장할 수 있다 *(신규 v2)*
- 지원한 공고의 등록자와 채팅으로 소통할 수 있다 *(신규 v2)*

### 4.5 관리자 사용자 시나리오

#### 4.5.1 관리 기능
- 나는 로그인을 할 수 있고, 그 결과 어드민 기능을 사용할 수 있다
- 나는 다른 사용자의 계정 상세 정보를 수정할 수 있다
- 나는 다른 사용자가 등록한 구인 공고를 수정할 수 있다

---

## 5. 사용자 스토리 매핑

### 5.1 공통 기능 (모델별 행위)

#### 5.1.1 User 모델
- **Register**: 나는 역할을 선택해서 새 사용자를 등록할 수 있다
- **Login**: 나는 내 계정으로 로그인을 할 수 있다
- **View**: 나는 내 계정 상세 정보를 조회할 수 있다
- **Modify**: 나는 내 계정 상세 정보를 수정할 수 있다
- **Delete**: 나는 내 계정을 삭제할 수 있다
- **Upload Avatar**: 나는 프로필 사진을 업로드할 수 있다 *(신규 v2)*

### 5.2 반려동물 주인 기능

#### 5.2.1 Job 모델 관련
- **Create**: 나는 펫시터에 한 마리 이상의 여러 유형의 반려동물 정보를 포함하는 구인 공고를 올릴 수 있다 (위치, 가격 포함 가능)
  - 관계: `job ← pets` (구인공고에 반려동물 정보 목록 포함, 1:N 관계)
- **List**: 나는 내가 등록한 구인공고 목록을 확인할 수 있다
  - 관계: `user → job` (사용자가 생성한 구인공고)
- **View**: 구인 공고를 등록하면 상세 내용을 조회할 수 있다
- **Modify**: 구인 공고를 등록하면 상세 내용을 수정할 수 있다
- **Delete**: 구인 공고를 등록하면 등록한 구인공고를 삭제할 수 있다
- **Upload Photo**: 공고에 사진을 업로드할 수 있다 *(신규 v2)*

#### 5.2.2 JobApplication 모델 관련
- **List**: 구인 공고를 등록하면 구인 공고에 지원한 돌봄 도우미를 확인할 수 있다
  - 관계: `user → job` (구인공고에 지원)
- **Approve**: 적절한 지원자가 있다면 승인할 수 있다

#### 5.2.3 Review 모델 관련 *(신규 v2)*
- **Create**: 공고가 완료되면 펫시터에게 별점(1~5)과 리뷰 텍스트를 남길 수 있다
  - 조건: 본인 공고 + approved 지원자 존재 + 공고당 1개 제한
- **Delete**: 본인이 작성한 리뷰를 삭제할 수 있다

#### 5.2.4 Chat 모델 관련 *(신규 v2)*
- **View Rooms**: 지원자와의 채팅방 목록을 확인할 수 있다
- **Send Message**: 지원자에게 메시지를 보낼 수 있다
- **View Messages**: 채팅방의 메시지 내역을 확인할 수 있다

### 5.3 돌봄 도우미 기능

#### 5.3.1 Job 모델 관련
- **List**: 나는 돌봄이 필요한 반려 동물(구인 공고) 목록을 조회할 수 있다
- **List with Filtering**: 나는 구인공고를 기준에 따라 필터링해서 페이지 단위로 조회할 수 있다
  - 필터링 기준: 동물 유형(animalType), 크기(size), 활동 유형(activity), 날짜 범위, 가격 범위(min_price, max_price) *(가격 범위 신규 v2)*
- **Search**: 나는 구인공고를 검색어로 검색할 수 있다
  - 검색 대상: 활동 내용, 반려동물 이름, 품종 등

#### 5.3.2 JobApplication 모델 관련
- **Create**: 마음에 드는 구인 공고가 있으면 지원할 수 있다
  - 채팅방은 첫 메시지 전송 시 생성됨 (지원만으로는 생성 안 됨) *(신규 v2)*

#### 5.3.3 Favorite 모델 관련 *(신규 v2)*
- **Toggle**: 공고 리스트/상세에서 즐겨찾기를 토글할 수 있다 (추가/제거)
- **List**: 즐겨찾기한 공고 목록을 확인할 수 있다

#### 5.3.4 Chat 모델 관련 *(신규 v2)*
- **View Rooms**: 공고 등록자와의 채팅방 목록을 확인할 수 있다
- **Send Message**: 공고 등록자에게 메시지를 보낼 수 있다
- **View Messages**: 채팅방의 메시지 내역을 확인할 수 있다

#### 5.3.5 Review 모델 관련 *(신규 v2)*
- **View**: 내가 받은 리뷰와 평점 목록을 확인할 수 있다

### 5.4 관리자 기능

#### 5.4.1 User 모델 관련
- **Modify**: 사용자의 프로파일을 수정할 수 있다
- **Delete**: 사용자를 삭제할 수 있다

#### 5.4.2 Job 모델 관련
- **Modify**: 다른 사용자가 등록한 구인 공고를 편집할 수 있다

---

## 6. 모델 관계도

```
User (사용자)
  ├─ creates → Job (구인공고)
  │              ├─ contains → Pet[] (반려동물 목록, 1:N 관계)
  │              │              └─ has → Photo[] (반려동물 사진)
  │              ├─ has → Photo[] (공고 사진)
  │              ├─ has → Review? (공고당 리뷰 1개)
  │              └─ has → Favorite[] (즐겨찾기 목록)
  ├─ applies → JobApplication (구인공고 지원)
  │              ├─ references → Job (구인공고)
  │              └─ has → ChatRoom? (채팅방, 첫 메시지 시 생성)
  │                          └─ contains → Message[] (메시지 목록)
  ├─ has → Photo[] (프로필 사진, "UserPhotos")
  ├─ uploads → Photo[] (업로드한 사진 전체, "UploadedPhotos")
  ├─ writes → Review[] (작성한 리뷰, "ReviewsGiven")
  ├─ receives → Review[] (받은 리뷰, "ReviewsReceived")
  ├─ sends → Message[] (전송한 메시지)
  └─ has → Favorite[] (즐겨찾기)
```

---

## 7. 역할별 권한 요약

| 역할 | 주요 기능 |
|------|----------|
| **반려동물 주인** | 구인공고 등록/수정/삭제(위치·가격·사진 포함), 지원자 확인 및 승인, 리뷰 작성/삭제, 채팅, 계정 관리 |
| **돌봄 도우미** | 필터링/페이징/검색/가격필터 공고 조회, 지원(채팅방 자동 생성), 즐겨찾기, 채팅, 리뷰 수신, 계정 관리 |
| **관리자** | 모든 사용자 및 구인공고 관리, 계정 관리 |

---

## 8. API 엔드포인트 요약

### 8.1 사용자 관련
- `POST /users` - 회원가입
- `POST /auth/login` - 로그인
- `GET /users/{id}` - 사용자 조회
- `PATCH /users/{id}` - 사용자 수정
- `DELETE /users/{id}` - 사용자 삭제
- `POST /users/{id}/avatar` - 프로필 사진 업로드 *(신규 v2)*
- `GET /users/{userId}/reviews` - 펫시터 리뷰 목록 조회 *(신규 v2)*

### 8.2 구인공고 관련
- `POST /jobs` - 구인공고 등록 (위치, 가격, 사진 포함 가능)
- `GET /jobs` - 구인공고 목록 조회
  - 쿼리 파라미터:
    - `page`: 페이지 번호 (기본값: 1)
    - `limit`: 페이지당 항목 수 (기본값: 10)
    - `animalType`: 동물 유형 필터 (DOG, CAT, BIRD, RABBIT, HAMSTER, ETC)
    - `size`: 크기 필터 (SMALL, MEDIUM, LARGE)
    - `activity`: 활동 유형 필터
    - `startDate`: 시작 날짜 필터
    - `endDate`: 종료 날짜 필터
    - `search`: 검색어 (활동 내용, 반려동물 이름, 품종 등)
    - `min_price`: 최소 가격 필터 *(신규 v2)*
    - `max_price`: 최대 가격 필터 *(신규 v2)*
- `GET /jobs/{id}` - 구인공고 상세 조회
- `PATCH /jobs/{id}` - 구인공고 수정
- `DELETE /jobs/{id}` - 구인공고 삭제
- `GET /users/{id}/jobs` - 특정 사용자의 구인공고 목록
- `POST /jobs/{id}/photos` - 공고 사진 업로드 *(신규 v2)*
- `POST /jobs/{jobId}/review` - 리뷰 작성 *(신규 v2)*

### 8.3 지원 관련
- `POST /jobs/{id}/job-applications` - 구인공고 지원 (채팅방 자동 생성)
- `GET /jobs/{id}/job-applications` - 구인공고별 지원 목록
- `PATCH /job-applications/{id}` - 지원 상태 수정 (승인/거절)

### 8.4 사진 업로드 *(신규 v2)*
- `POST /users/{id}/avatar` - 프로필 사진 업로드 (multipart/form-data, field: file)
- `POST /jobs/{id}/photos` - 공고 사진 업로드 (multipart/form-data, field: file)
- `POST /pets/{id}/photo` - 반려동물 사진 업로드 (multipart/form-data, field: file)

### 8.5 리뷰 *(신규 v2)*
- `POST /jobs/{jobId}/review` - 리뷰 작성 (PetOwner만, body: { rating, comment })
- `GET /users/{userId}/reviews` - 특정 펫시터의 리뷰 목록 (query: sort=createdAt:desc|rating:desc)
- `DELETE /reviews/{id}` - 리뷰 삭제 (작성자만)

### 8.6 채팅 *(신규 v2)*

#### REST (메시지 히스토리 조회)
- `GET /chat-rooms` - 내 채팅방 목록 (인증 필요, 채팅 기록이 있는 경우만 존재)
- `GET /chat-rooms/{id}/messages` - 채팅방 메시지 히스토리 (query: limit, cursor)

#### WebSocket (실시간 메시지)
- `ws://host/chat` - Socket.io 연결 (Authorization 헤더 또는 쿼리 파라미터로 JWT 전달)
- `joinRoom` 이벤트 - 채팅방 입장 (payload: { jobApplicationId })
  - 채팅방 없으면 이 시점에 자동 생성 (Lazy Creation)
- `sendMessage` 이벤트 - 메시지 전송 (payload: { chatRoomId, content })
- `receiveMessage` 이벤트 - 메시지 수신 (서버→클라이언트)

### 8.7 즐겨찾기 *(신규 v2)*
- `POST /favorites` - 즐겨찾기 토글 (PetSitter만, body: { job_id })
- `GET /favorites` - 내 즐겨찾기 목록 (인증 필요)
- `DELETE /favorites/{jobId}` - 즐겨찾기 제거

---

## 9. 추가 요구사항 및 개선사항

### 9.1 피드백 반영 (v1)
- **다중 반려동물 지원**: 구인공고에 반려동물 여러 마리를 포함할 수 있도록 개선
- **다양한 동물 유형 지원**: 강아지뿐만 아니라 고양이, 새, 토끼, 햄스터 등 다양한 반려동물 지원
- **구인공고 조회 기능 강화**: 필터링, 페이징, 검색 기능 추가로 사용자 편의성 향상

### 9.2 신규 사용자 스토리 (v1)
- **반려동물 돌봄 도우미는 구인공고를 기준에 따라 필터링해서 페이지 단위로 조회할 수 있다**
- **반려동물 주인은 한 마리 이상의 여러 유형의 반려동물 정보를 포함하는 구인 공고를 등록할 수 있다**

### 9.3 신규 기능 요구사항 (v2)

#### 9.3.1 사진 업로드
- 허용 형식: jpg, jpeg, png, webp
- 최대 파일 크기: 5MB
- 저장 방식: 로컬 스토리지 (./uploads/) → 추후 클라우드 스토리지 마이그레이션 가능
- 파일명: UUID 기반 자동 생성 (원본 파일명 노출 금지, 보안)
- Photo 테이블로 사진 메타데이터 별도 관리
  - User/Job/Pet 모델에 URL 필드 직접 추가 안 함
  - 각 엔티티는 Photo 테이블과 1:N 관계로 연결
  - 동일 엔티티에 여러 장 업로드 가능 (공고 사진 등)
  - 업로드 시 DB에 메타데이터(URL, 파일명, 크기, 형식) 저장
- 반려동물 사진은 갤러리/카메라 선택 가능 (클라이언트 구현)

#### 9.3.2 리뷰 및 평점
- 별점: 1~5 정수
- 리뷰 텍스트: 선택 사항
- 리뷰 정렬: 최근순 / 높은평점순
- 작성 조건: 본인 공고 + approved 지원자 존재 + 공고당 1개 제한
- 평점 기반 정렬, 추천 도우미 기능 구현 가능

#### 9.3.3 공고 필드 확장
- 위치 정보: 주소(텍스트), 위도, 경도 (모두 선택 사항)
- 가격: 금액(원) + 유형(hourly/daily) (선택 사항)
- 가격 필터링: min_price, max_price 범위 검색 지원

#### 9.3.4 채팅 기능
- 채팅방은 **첫 메시지 전송 시 자동 생성** (Lazy Creation)
  - 지원만 하고 채팅하지 않는 경우 ChatRoom 레코드 생성 안 함
  - 첫 메시지 전송 API 호출 시 ChatRoom이 없으면 그때 생성
  - job_application_id를 기준으로 ChatRoom 존재 여부 확인 후 없으면 create
- 접근 권한: 공고 등록자(PetOwner) + 지원자(PetSitter)만
- **WebSocket (Socket.io)** 방식으로 실시간 양방향 통신
  - NestJS Gateway (`@WebSocketGateway`) 사용
  - 인증: JWT 토큰을 WebSocket 연결 핸드셰이크에 포함
  - 이벤트: `joinRoom`, `sendMessage`, `receiveMessage`, `error`
  - 메시지는 DB에 저장하여 히스토리 조회 가능
- 메시지 히스토리: REST API로 조회 (커서 기반 페이지네이션)

#### 9.3.5 즐겨찾기
- 대상: PetSitter만 사용 가능
- 토글 동작: 추가/제거 (같은 엔드포인트로 처리)
- 공고 삭제 시 관련 즐겨찾기 자동 삭제 (cascade)

### 9.4 DB 스키마 변경 요약 (v2)
- **신규 Enum**: PriceType (hourly, daily)
- **User 수정**: photos 관계 추가 (URL 필드 직접 추가 안 함)
- **Job 수정**: address, latitude, longitude, price, price_type 필드 추가 + photos 관계 추가
- **Pet 수정**: photos 관계 추가 (URL 필드 직접 추가 안 함)
- **신규 모델**: Photo, Review, ChatRoom, Message, Favorite

### 9.5 신규 서버 모듈 목록 (v2)
| 모듈 | 핵심 기능 |
|------|----------|
| `uploads` | 파일 업로드 처리 + 정적 파일 서빙 |
| `reviews` | 리뷰 CRUD + 평점 집계 |
| `chat` | 채팅방 관리 + 메시지 송수신 |
| `favorites` | 즐겨찾기 토글/목록 조회 |

기존 수정 모듈:
- `jobs` - Job 모델 신규 필드 반영 (DTO, Input, Model, Service 수정)
- `job-application` - 수정 없음 (채팅방은 chat 모듈에서 lazy 생성)

---

**문서 버전**: 3.0
**최종 수정일**: 2026-02-10
